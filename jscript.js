const translations = {
  sr: {
    brand: {
      name: 'TravelWave',
      tagline: 'Vaš vodič kroz nezaboravna putovanja'
    },
    nav: {
      home: 'Početna',
      arrangements: 'Aranžmani',
      europe: 'Evropa',
      summer: 'Leto 2025',
      winter: 'Zima 2025',
      gallery: 'Galerija',
      account: 'Moj nalog',
      about: 'O nama'
    },
    footer: {
      copy: 'Copyright 2025, Mihajlo Đurović, Matija Leković, Odsek za softversko inženjerstvo, Elektrotehnički fakultet Univerziteta u Beogradu'
    },
    pageTitles: {
      home: 'TravelWave | Početna',
      europe: 'TravelWave | Evropa',
      summer: 'TravelWave | Leto 2025',
      winter: 'TravelWave | Zima 2025',
      gallery: 'TravelWave | Galerija',
      account: 'TravelWave | Moj nalog',
      about: 'TravelWave | O nama'
    },
    home: {
      hero: {
        title: 'Otkrijte svoju sledeću destinaciju sa TravelWave agencijom',
        subtitle: 'Specijalizovani smo za aranžmane širom sveta uz punu podršku našeg tima i proverene partnere.',
        ctaSummer: 'Pogledaj letnje aranžmane',
        ctaAccount: 'Prijavi se ili registruj nalog'
      },
      news: {
        title: 'Aktuelno u agenciji',
        item1: {
          title: 'Nova ponuda za porodično letovanje u Halkidikiju',
          copy: 'Popusti do 15% za rezervacije do kraja maja, sa uključenim prevozom i dečijim animacionim programom.'
        },
        item2: {
          title: 'Upoznajte našeg novog turističkog vodiča Marka',
          copy: 'Marko donosi iskustvo sa više od 120 realizovanih tura širom Evrope.'
        },
        item3: {
          title: 'Ekskluzivne city-break ponude za jesen 2025.',
          copy: 'Rezervišite ranije i obezbedite direktan let, hotelski prevoz i obilazak uz lokalnog vodiča.'
        }
      },
      featured: {
        title: 'Top izbor za naredni mesec',
        card1: {
          title: 'Letovanje u Grčkoj',
          copy: 'Sedam noćenja u luksuznom hotelu na Sitoniji, polupansion i avio-prevoz uključeni u cenu.',
          price: 'Cena: 499 €'
        },
        card2: {
          title: 'All inclusive Turska',
          copy: 'Deset noćenja u hotelu sa pet zvezdica u Alanji, kompletna all inclusive usluga i transfer od/do aerodroma.',
          price: 'Cena: 799 €'
        },
        card3: {
          title: 'Egipat – Hurgada',
          copy: 'Sedam noćenja u hotelu sa privatnom plažom, polupansion i fakultativni izleti.',
          price: 'Cena: 599 €'
        }
      },
      rated: {
        title: '🏆 Najbolje ocenjeni aranžmani',
        card1: {
          title: 'Italija – Rim',
          rating: 'Ocena: 4.7',
          review: '„Predivan aranžman, vodiči su bili fantastični!”'
        },
        card2: {
          title: 'Crna Gora – Budva',
          rating: 'Ocena: 4.5',
          review: '„Odličan smeštaj i prelepa plaža, sigurno se vraćam.”'
        },
        card3: {
          title: 'Francuska – Pariz',
          rating: 'Ocena: 5.0',
          review: '„Romantično iskustvo, hotel je bio na par minuta od Ajfelovog tornja!”'
        }
      }
    },
    gallery: {
      title: 'Foto i video galerija',
      videoTitle: 'Video zapisi sa putovanja',
      video1: {
        caption: 'Santorini iz vazduha – pogledajte kako izgleda najpopularnije ostrvo u Grčkoj.'
      },
      video2: {
        caption: 'Zimska avantura na Alpima – skijanje, spa i nezaboravne staze.'
      },
      photoTitle: 'Fotografije naših aranžmana'
    },
    arrangements: {
      searchPlaceholder: 'Pretraži aranžman po nazivu...',
      sortAsc: 'Sortiraj A-Z',
      sortDesc: 'Sortiraj Z-A',
      reserve: 'Rezerviši'
    },
    europe: {
      title: 'Evropske destinacije',
      subtitle: 'Pažljivo biramo gradove i ture koje kombinuju kulturu, gastronomiju i jedinstvene doživljaje.',
      badge: 'City-break i višednevni aranžmani',
      prague: {
        title: 'Prag',
        copy: 'Tri noćenja u centru Praga, doručak uključen i licencirani vodič na srpskom jeziku.',
        price: 'Cena: 299 €'
      },
      vienna: {
        title: 'Beč',
        copy: 'Dva noćenja, obilazak znamenitosti i autobuski prevoz iz Beograda uz lokalnog vodiča.',
        price: 'Cena: 249 €'
      },
      budapest: {
        title: 'Budimpešta',
        copy: 'Vikend aranžman sa krstarenjem Dunavom i hotelom sa četiri zvezdice u centru grada.',
        price: 'Cena: 199 €'
      }
    },
    summer: {
      title: 'Letnji aranžmani 2025',
      subtitle: 'Prepustite se suncu, toplom moru i avanturama koje smo pripremili za predstojeću sezonu.',
      badge: 'All inclusive ponude i apartmani',
      budva: {
        title: 'Budva',
        copy: 'Sedam noćenja u hotelu sa tri zvezdice, polupansion i organizovan prevoz autobusom.',
        price: 'Cena: 399 €'
      },
      halkidiki: {
        title: 'Halkidiki',
        copy: 'Deset noćenja u apartmanskom smeštaju, sopstveni prevoz i popust za iznamljivanje čamca.',
        price: 'Cena: 299 €'
      },
      hurghada: {
        title: 'Hurgada',
        copy: 'All inclusive aranžman, sedam noćenja i direktan let iz Beograda sa uključenim transferom.',
        price: 'Cena: 699 €'
      }
    },
    winter: {
      title: 'Zimski aranžmani 2025',
      subtitle: 'Ski pass, wellness i avanture u snegu – pažljivo kreirani paketi za ljubitelje zime.',
      badge: 'Planine i termalni centri',
      kopaonik: {
        title: 'Kopaonik',
        copy: 'Pet noćenja u planinskom hotelu sa spa centrom i ski pass-om uključenim u cenu.',
        price: 'Cena: 499 €'
      },
      zlatibor: {
        title: 'Zlatibor',
        copy: 'Četiri noćenja u apartmanskom smeštaju sa wellness centrom i panoramskom žičarom.',
        price: 'Cena: 299 €'
      },
      tara: {
        title: 'Tara',
        copy: 'Šest noćenja sa autobuskim prevozom iz Beograda i organizovanim zimskim aktivnostima.',
        price: 'Cena: 199 €'
      }
    },
    account: {
      title: 'Moje rezervacije',
      subtitle: 'Ovde pregledate, potvrđujete i otkazujete aranžmane koje ste sačuvali.',
      clearAll: 'Obriši sve rezervacije',
      clearConfirm: 'Da li ste sigurni da želite da obrišete sve rezervacije?',
      empty: 'Trenutno nemate rezervisanih aranžmana.',
      priceLabel: 'Cena:',
      cancel: 'Otkaži rezervaciju',
      upcomingTitle: 'Zakazane destinacije',
      upcomingDescription: 'Aktivne rezervacije koje još nisu počele.',
      startLabel: 'Datum polaska:',
      daysRemaining: 'Dana do polaska:',
      cancelUntil: 'Otkazivanje moguće do',
      cancelUnavailable: 'Otkazivanje više nije moguće jer je preostalo manje od 5 dana do polaska.',
      unknownStart: 'Datum polaska nije definisan. Otkazivanje je uvek dostupno.',
      visitedTitle: 'Posećene destinacije',
      visitedDescription: 'Aranžmani koji su završeni. Podelite utiske ocenom.',
      visitedEmpty: 'Još uvek nemate posećenih destinacija.',
      ratingPrompt: 'Podelite utisak ocenom (1-5).',
      ratingLabel: 'Vaša ocena:',
      ratingPlaceholder: 'Izaberite ocenu',
      saveRating: 'Sačuvaj ocenu',
      ratingSaved: 'Ocena sačuvana. Hvala!',
      currentRating: 'Trenutna ocena:',
      noRating: 'Još niste ostavili ocenu.',
      ratingRequired: 'Molimo izaberite ocenu pre čuvanja.'
    },
    about: {
      title: 'Upoznajte TravelWave tim',
      subtitle: 'Više od jedne decenije kreiramo putovanja po meri – od avanturističkih tura do luksuznih odmora.',
      mission: {
        title: 'Naša misija',
        copy: 'Verujemo da je svako putovanje prilika da se nauči nešto novo. Zato svaki aranžman gradimo oko autentičnih iskustava i lokalnih partnera.'
      },
      values: {
        title: 'Naše vrednosti',
        copy: 'Transparentnost, odgovorno putovanje i sigurnost putnika su temelji našeg svakodnevnog rada.'
      },
      awards: {
        title: 'Nagrade',
        item1: 'Najbolja agencija jugoistočne Evrope 2021.',
        item2: 'Priznanje za kvalitet usluge 2022.',
        item3: 'Top izbor putnika 2023.'
      },
      team: {
        title: 'Naš tim',
        copy: 'Sastavljeni smo od licenciranih turističkih vodiča, stručnjaka za destinacije i savetnika koji su obišli preko 60 zemalja. Svaki član tima poseduje sertifikate za pružanje prve pomoći i specijalizovane obuke za rad sa grupama.'
      },
      contact: {
        title: 'Kontakt',
        phoneLabel: 'Telefon:',
        emailLabel: 'E-pošta:',
        officeLabel: 'Radno vreme:',
        officeHours: 'Radnim danima 09-18h, subotom 10-14h.'
      },
      reasons: {
        title: 'Zašto izabrati TravelWave?',
        item1: '24/7 podrška putnicima i lokalni asistenti na destinaciji.',
        item2: 'Fleksibilne opcije plaćanja i mogućnost rate bez kamate.',
        item3: 'Ekskluzivni popusti zahvaljujući partnerstvu sa 150 hotela.'
      }
    }
  },
  en: {
    brand: {
      name: 'TravelWave',
      tagline: 'Your guide to unforgettable journeys'
    },
    nav: {
      home: 'Home',
      arrangements: 'Packages',
      europe: 'Europe',
      summer: 'Summer 2025',
      winter: 'Winter 2025',
      gallery: 'Gallery',
      account: 'My account',
      about: 'About us'
    },
    footer: {
      copy: 'Copyright 2025, Mihajlo Đurović, Matija Leković, Department of Software Engineering, School of Electrical Engineering, University of Belgrade'
    },
    pageTitles: {
      home: 'TravelWave | Home',
      europe: 'TravelWave | Europe',
      summer: 'TravelWave | Summer 2025',
      winter: 'TravelWave | Winter 2025',
      gallery: 'TravelWave | Gallery',
      account: 'TravelWave | My Account',
      about: 'TravelWave | About Us'
    },
    home: {
      hero: {
        title: 'Discover your next destination with TravelWave',
        subtitle: 'We specialize in worldwide packages backed by our dedicated team and trusted partners.',
        ctaSummer: 'Browse summer packages',
        ctaAccount: 'Sign in or create an account'
      },
      news: {
        title: 'Agency highlights',
        item1: {
          title: 'New family holiday offer in Halkidiki',
          copy: 'Up to 15% early booking discount until the end of May, including transport and a kids’ animation program.'
        },
        item2: {
          title: 'Meet Marko, our newest tour guide',
          copy: 'Marko joins us with experience from more than 120 guided tours across Europe.'
        },
        item3: {
          title: 'Exclusive city-break deals for autumn 2025',
          copy: 'Book early to secure direct flights, hotel transfers and sightseeing with a local guide.'
        }
      },
      featured: {
        title: 'Top picks for next month',
        card1: {
          title: 'Summer escape to Greece',
          copy: 'Seven nights at a luxury hotel in Sithonia with half-board service and flights included.',
          price: 'Price: €499'
        },
        card2: {
          title: 'All inclusive Turkey',
          copy: 'Ten nights at a five-star hotel in Alanya, premium all inclusive service and airport transfers.',
          price: 'Price: €799'
        },
        card3: {
          title: 'Egypt – Hurghada',
          copy: 'Seven nights at a private beach hotel, half-board and optional excursions.',
          price: 'Price: €599'
        }
      },
      rated: {
        title: '🏆 Top-rated packages',
        card1: {
          title: 'Italy – Rome',
          rating: 'Rating: 4.7',
          review: '“Wonderful tour, the guides were fantastic!”'
        },
        card2: {
          title: 'Montenegro – Budva',
          rating: 'Rating: 4.5',
          review: '“Great accommodation and beautiful beaches—we will be back.”'
        },
        card3: {
          title: 'France – Paris',
          rating: 'Rating: 5.0',
          review: '“A romantic experience, the hotel was minutes from the Eiffel Tower!”'
        }
      }
    },
    gallery: {
      title: 'Photo and video gallery',
      videoTitle: 'Travel video highlights',
      video1: {
        caption: 'Santorini from above – experience Greece’s most iconic island.'
      },
      video2: {
        caption: 'Winter thrills in the Alps – skiing, spa breaks and unforgettable slopes.'
      },
      photoTitle: 'Photos from our packages'
    },
    arrangements: {
      searchPlaceholder: 'Search packages by name...',
      sortAsc: 'Sort A-Z',
      sortDesc: 'Sort Z-A',
      reserve: 'Reserve'
    },
    europe: {
      title: 'European destinations',
      subtitle: 'We curate cities and tours that blend culture, gastronomy and unique experiences.',
      badge: 'City-breaks and multi-day tours',
      prague: {
        title: 'Prague',
        copy: 'Three nights in central Prague with breakfast and a licensed Serbian-speaking guide.',
        price: 'Price: €299'
      },
      vienna: {
        title: 'Vienna',
        copy: 'Two nights, guided sightseeing and coach transport from Belgrade with a local guide.',
        price: 'Price: €249'
      },
      budapest: {
        title: 'Budapest',
        copy: 'Weekend break with a Danube cruise and four-star hotel in the city centre.',
        price: 'Price: €199'
      }
    },
    summer: {
      title: 'Summer packages 2025',
      subtitle: 'Enjoy the sun, warm seas and adventures we prepared for the upcoming season.',
      badge: 'All inclusive deals and apartments',
      budva: {
        title: 'Budva',
        copy: 'Seven nights at a three-star hotel, half-board service and organised coach transport.',
        price: 'Price: €399'
      },
      halkidiki: {
        title: 'Halkidiki',
        copy: 'Ten nights in apartment accommodation, self-drive and a discount on boat rental.',
        price: 'Price: €299'
      },
      hurghada: {
        title: 'Hurghada',
        copy: 'All inclusive stay, seven nights and direct flights from Belgrade with transfers.',
        price: 'Price: €699'
      }
    },
    winter: {
      title: 'Winter packages 2025',
      subtitle: 'Skipasses, wellness and snowy adventures – tailor-made packages for winter lovers.',
      badge: 'Mountain resorts and thermal spas',
      kopaonik: {
        title: 'Kopaonik',
        copy: 'Five nights at a mountain hotel with spa access and skipass included in the price.',
        price: 'Price: €499'
      },
      zlatibor: {
        title: 'Zlatibor',
        copy: 'Four nights in apartment accommodation with wellness centre and panoramic cable car.',
        price: 'Price: €299'
      },
      tara: {
        title: 'Tara',
        copy: 'Six nights with coach transport from Belgrade and organised winter activities.',
        price: 'Price: €199'
      }
    },
    account: {
      title: 'My reservations',
      subtitle: 'Review, confirm and cancel the packages you have saved.',
      clearAll: 'Delete all reservations',
      clearConfirm: 'Are you sure you want to delete all reservations?',
      empty: 'You do not have any reservations yet.',
      priceLabel: 'Price:',
      cancel: 'Cancel reservation',
      upcomingTitle: 'Upcoming trips',
      upcomingDescription: 'Active reservations that have not started yet.',
      startLabel: 'Departure date:',
      daysRemaining: 'Days until departure:',
      cancelUntil: 'Cancellation possible until',
      cancelUnavailable: 'Cancellation is no longer possible because there are fewer than 5 days until departure.',
      unknownStart: 'Departure date is not set. You can cancel at any time.',
      visitedTitle: 'Visited destinations',
      visitedDescription: 'Trips that have already finished. Share your experience with a rating.',
      visitedEmpty: 'You do not have any visited destinations yet.',
      ratingPrompt: 'Share your experience with a rating (1-5).',
      ratingLabel: 'Your rating:',
      ratingPlaceholder: 'Select a rating',
      saveRating: 'Save rating',
      ratingSaved: 'Rating saved. Thank you!',
      currentRating: 'Current rating:',
      noRating: 'You have not rated this trip yet.',
      ratingRequired: 'Please select a rating before saving.'
    },
    about: {
      title: 'Meet the TravelWave team',
      subtitle: 'For over a decade we have crafted tailor-made trips—from adventure tours to luxury escapes.',
      mission: {
        title: 'Our mission',
        copy: 'We believe every journey is a chance to learn something new, so we build each package around authentic experiences and local partners.'
      },
      values: {
        title: 'Our values',
        copy: 'Transparency, responsible travel and passenger safety are the foundations of our daily work.'
      },
      awards: {
        title: 'Awards',
        item1: 'Best agency in South-Eastern Europe 2021.',
        item2: 'Service quality award 2022.',
        item3: 'Travellers’ top choice 2023.'
      },
      team: {
        title: 'Our team',
        copy: 'We are a group of licensed tour guides, destination experts and advisors who have visited more than 60 countries. Every team member is certified in first aid and trained to work with groups.'
      },
      contact: {
        title: 'Contact',
        phoneLabel: 'Phone:',
        emailLabel: 'Email:',
        officeLabel: 'Office hours:',
        officeHours: 'Monday to Friday 9am–6pm, Saturday 10am–2pm.'
      },
      reasons: {
        title: 'Why choose TravelWave?',
        item1: '24/7 traveller support and local assistants at each destination.',
        item2: 'Flexible payment plans with interest-free instalments.',
        item3: 'Exclusive discounts through partnerships with 150 hotels.'
      }
    }
  }
};

let currentLanguage = 'sr';

/**
 * Resolves a translation key for the requested language, falling back to Serbian when needed.
 * @param {string} key Dot-separated translation path (e.g. `home.hero.title`).
 * @param {string} [lang=currentLanguage] Language code to use when looking up the key.
 * @returns {string|undefined} Matching translation string, or undefined if nothing is found.
 */
function translateKey(key, lang = currentLanguage) {
  const result = key.split('.').reduce((acc, part) => (acc && acc[part] !== undefined ? acc[part] : undefined), translations[lang]);
  if (result !== undefined) {
    return result;
  }
  if (lang !== 'sr') {
    return key.split('.').reduce((acc, part) => (acc && acc[part] !== undefined ? acc[part] : undefined), translations.sr);
  }
  return undefined;
}

/**
 * Updates text or attributes on elements that declare `data-i18n-key` according to the active language.
 * @param {string} lang Language code that was just selected.
 */
function applyTranslations(lang) {
  document.querySelectorAll('[data-i18n-key]').forEach(element => {
    const key = element.getAttribute('data-i18n-key');
    if (!key) return;
    const translation = translateKey(key, lang);
    if (translation === undefined) return;
    const attr = element.getAttribute('data-i18n-attr');
    if (attr) {
      element.setAttribute(attr, translation);
    } else {
      element.textContent = translation;
    }
  });
}

/**
 * Synchronises the page `<title>` with the current route and UI language.
 * @param {string} lang Active language code.
 */
function updateDocumentTitle(lang) {
  const pageKey = document.body.dataset.page || 'home';
  const title = translateKey(`pageTitles.${pageKey}`, lang);
  if (title) {
    document.title = title;
  }
}

/**
 * Marks the language toggle buttons so the active language is visually highlighted.
 * @param {string} lang Active language code.
 */
function syncLanguageToggle(lang) {
  document.querySelectorAll('.lang-btn').forEach(button => {
    const isActive = button.dataset.lang === lang;
    button.classList.toggle('active', isActive);
  });
}

/**
 * Highlights the current page in the navigation menu based on the `data-page` attribute on `<body>`.
 */
function highlightNavigation() {
  const pageKey = document.body.dataset.page;
  if (!pageKey) return;
  document.querySelectorAll('[data-page-target]').forEach(link => {
    const isCurrent = link.dataset.pageTarget === pageKey;
    link.classList.toggle('curr', isCurrent);
  });
}

/**
 * Applies a new UI language, optionally persisting the choice, and refreshes dependent UI state.
 * @param {string} lang Requested language code.
 * @param {boolean} [persist=true] Whether to save the selection to `localStorage`.
 */
function setLanguage(lang, persist = true) {
  if (!translations[lang]) {
    lang = 'sr';
  }
  currentLanguage = lang;
  if (persist) {
    localStorage.setItem('siteLang', lang);
  }
  document.documentElement.setAttribute('lang', lang === 'sr' ? 'sr' : 'en');
  document.body.dataset.currentLang = lang;
  applyTranslations(lang);
  updateDocumentTitle(lang);
  syncLanguageToggle(lang);
  highlightNavigation();
  if (document.body.dataset.page === 'account') {
    prikaziRezervacije();
  }
}

/**
 * Initialises the UI language based on the saved preference, defaulting to Serbian.
 */
function initLanguage() {
  const stored = localStorage.getItem('siteLang');
  const initialLang = stored && translations[stored] ? stored : 'sr';
  setLanguage(initialLang, false);
}

/**
 * Sorts destination cards alphabetically in ascending or descending order.
 * @param {'asc'|'desc'} order Determines the sort direction.
 */
function sortCards(order) {
  const container = document.getElementById('destinacije-cards');
  if (!container) return;
  const cards = Array.from(container.getElementsByClassName('destinacija-card'));
  const locale = currentLanguage === 'sr' ? 'sr' : 'en';
  cards.sort((a, b) => {
    const nameA = a.querySelector('.card-title').textContent.trim().toLowerCase();
    const nameB = b.querySelector('.card-title').textContent.trim().toLowerCase();
    const comparison = nameA.localeCompare(nameB, locale);
    return order === 'asc' ? comparison : -comparison;
  });
  cards.forEach(card => container.appendChild(card));
}

/**
 * Filters destination cards by matching the search term against the card title.
 * The search input and card grid are expected to exist on destinations pages.
 */
function filterCards() {
  const input = document.getElementById('pretraga');
  const container = document.getElementById('destinacije-cards');
  if (!input || !container) return;
  const query = input.value.toLowerCase();
  container.querySelectorAll('.destinacija-card').forEach(card => {
    const title = card.querySelector('.card-title').textContent.toLowerCase();
    card.style.display = title.includes(query) ? '' : 'none';
  });
}

/**
 * Number of milliseconds in a single day, used when calculating date differences.
 */
const MS_PER_DAY = 24 * 60 * 60 * 1000;

/**
 * Loads reservations from `localStorage`, returning an empty array on failure or malformed data.
 * @returns {Array<object>} Parsed reservation records.
 */
function safeParseReservations() {
  try {
    const parsed = JSON.parse(localStorage.getItem('rezervacije') || '[]');
    return Array.isArray(parsed) ? parsed : [];
  } catch (error) {
    console.warn('Neuspelo učitavanje rezervacija iz localStorage-a.', error);
    return [];
  }
}

/**
 * Serialises the reservations array back to `localStorage`.
 * @param {Array<object>} reservations Reservations to persist.
 */
function persistReservations(reservations) {
  localStorage.setItem('rezervacije', JSON.stringify(reservations));
}

/**
 * Converts an arbitrary date-like value to the canonical YYYY-MM-DD string used in storage.
 * @param {unknown} value Any value that might represent a date.
 * @returns {string|undefined} Normalised date string or undefined for invalid inputs.
 */
function normalizeDateString(value) {
  if (!value) {
    return undefined;
  }
  if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(value)) {
    return value;
  }
  const parsed = new Date(value);
  if (Number.isNaN(parsed.valueOf())) {
    return undefined;
  }
  const year = parsed.getFullYear();
  const month = String(parsed.getMonth() + 1).padStart(2, '0');
  const day = String(parsed.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

/**
 * Attempts to convert a stored date value into a `Date` instance.
 * @param {unknown} value Value read from storage.
 * @returns {Date|null} `Date` object when parsing succeeds, otherwise null.
 */
function parseStoredDate(value) {
  if (!value) {
    return null;
  }
  if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(value)) {
    const [year, month, day] = value.split('-').map(Number);
    return new Date(year, month - 1, day);
  }
  const parsed = new Date(value);
  return Number.isNaN(parsed.valueOf()) ? null : parsed;
}

/**
 * Ensures each reservation object has required fields and sane values.
 * @param {Array<object>} reservations Reservations read from storage.
 * @returns {boolean} True if the input array was mutated and should be re-saved.
 */
function ensureReservationDefaults(reservations) {
  const timestampSeed = Date.now();
  let shouldPersist = false;
  reservations.forEach((reservation, index) => {
    if (!reservation || typeof reservation !== 'object') {
      return;
    }
    if (!reservation.id) {
      reservation.id = `res-${timestampSeed}-${index}`;
      shouldPersist = true;
    }
    if (reservation.startDate) {
      const normalized = normalizeDateString(reservation.startDate);
      if (normalized && normalized !== reservation.startDate) {
        reservation.startDate = normalized;
        shouldPersist = true;
      }
    }
    if (reservation.rating !== undefined && reservation.rating !== null) {
      const numericRating = Number(reservation.rating);
      if (!Number.isFinite(numericRating)) {
        reservation.rating = null;
        shouldPersist = true;
      } else {
        const bounded = Math.min(5, Math.max(1, Math.round(numericRating)));
        if (bounded !== reservation.rating) {
          reservation.rating = bounded;
          shouldPersist = true;
        }
      }
    }
  });
  return shouldPersist;
}

/**
 * Resolves a value that may be localised by picking the best match for the active language.
 * @param {object|string} value Either a plain string or an object of translations.
 * @returns {string|undefined} String for the current language, if available.
 */
function resolveLocalizedValue(value) {
  if (typeof value === 'object' && value !== null) {
    return value[currentLanguage] || value.sr || Object.values(value)[0];
  }
  return value;
}

/**
 * Formats a `Date` instance into a language-specific readable string.
 * @param {Date} date Date to format.
 * @param {string} [lang=currentLanguage] Language code that determines the locale.
 * @returns {string} Formatted date or an empty string if formatting fails.
 */
function formatLocalizedDate(date, lang = currentLanguage) {
  if (!(date instanceof Date) || Number.isNaN(date.valueOf())) {
    return '';
  }
  const locale = lang === 'sr' ? 'sr-RS' : 'en-GB';
  try {
    return new Intl.DateTimeFormat(locale, { day: '2-digit', month: 'long', year: 'numeric' }).format(date);
  } catch (error) {
    console.warn('Intl.DateTimeFormat nije dostupan, koristi se toLocaleDateString.', error);
    return date.toLocaleDateString();
  }
}

/**
 * Builds and renders the upcoming and visited reservation lists, wiring up their event handlers.
 */
function prikaziRezervacije() {
  const upcomingContainer = document.getElementById('rezervacije-lista');
  const upcomingEmptyState = document.getElementById('nema-rezervacija');
  const visitedContainer = document.getElementById('posecene-lista');
  const visitedEmptyState = document.getElementById('nema-posecenih');

  if (!upcomingContainer || !upcomingEmptyState || !visitedContainer || !visitedEmptyState) {
    return;
  }

  const reservations = safeParseReservations();
  const shouldPersistAfterDefaults = ensureReservationDefaults(reservations);

  const today = new Date();
  const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  let shouldPersistVisited = shouldPersistAfterDefaults;

  const upcoming = [];
  const visited = [];

  reservations.forEach((reservation, index) => {
    if (!reservation || typeof reservation !== 'object') {
      return;
    }
    const startDate = parseStoredDate(reservation.startDate);
    const isVisited = startDate ? startDate < startOfToday : Boolean(reservation.visited);
    if (reservation.visited !== isVisited) {
      reservation.visited = isVisited;
      shouldPersistVisited = true;
    }
    const targetList = isVisited ? visited : upcoming;
    targetList.push({ reservation, index, startDate });
  });

  if (shouldPersistVisited) {
    persistReservations(reservations);
  }

  const clearButton = document.getElementById('clear-reservations');
  if (clearButton) {
    if (reservations.length === 0) {
      clearButton.setAttribute('disabled', 'disabled');
    } else {
      clearButton.removeAttribute('disabled');
    }
  }

  const priceLabel = translateKey('account.priceLabel') || 'Cena:';
  const cancelLabel = translateKey('account.cancel') || 'Otkaži rezervaciju';
  const startLabel = translateKey('account.startLabel') || 'Datum polaska:';
  const daysLabel = translateKey('account.daysRemaining') || 'Dana do polaska:';
  const cancelUntilLabel = translateKey('account.cancelUntil') || 'Otkazivanje moguće do';
  const cancelUnavailable = translateKey('account.cancelUnavailable') || 'Otkazivanje više nije moguće.';
  const unknownStart = translateKey('account.unknownStart') || 'Datum polaska nije definisan. Otkazivanje je uvek dostupno.';
  const ratingPrompt = translateKey('account.ratingPrompt') || 'Podelite utisak ocenom (1-5).';
  const ratingLabel = translateKey('account.ratingLabel') || 'Vaša ocena:';
  const ratingPlaceholder = translateKey('account.ratingPlaceholder') || 'Izaberite ocenu';
  const saveRating = translateKey('account.saveRating') || 'Sačuvaj ocenu';
  const ratingSaved = translateKey('account.ratingSaved') || 'Ocena sačuvana.';
  const currentRatingLabel = translateKey('account.currentRating') || 'Trenutna ocena:';
  const noRatingLabel = translateKey('account.noRating') || 'Još niste ostavili ocenu.';
  const ratingRequired = translateKey('account.ratingRequired') || 'Molimo izaberite ocenu pre čuvanja.';

  upcomingContainer.innerHTML = '';
  if (upcoming.length === 0) {
    upcomingEmptyState.style.display = 'block';
  } else {
    upcomingEmptyState.style.display = 'none';
    upcoming.forEach(({ reservation, startDate }) => {
      const name = resolveLocalizedValue(reservation.naziv) || '';
      const description = resolveLocalizedValue(reservation.opis) || '';
      const price = reservation.cena || '';

      let cancelDisabled = false;
      let cancellationNote = unknownStart;
      let daysUntilDeparture = '';

      if (startDate) {
        const diffDays = Math.round((startDate - startOfToday) / MS_PER_DAY);
        daysUntilDeparture = diffDays >= 0 ? diffDays : 0;
        if (diffDays >= 5) {
          const deadline = new Date(startDate.getTime());
          deadline.setDate(deadline.getDate() - 5);
          cancellationNote = `${cancelUntilLabel} ${formatLocalizedDate(deadline)}.`;
        } else {
          cancellationNote = cancelUnavailable;
          cancelDisabled = true;
        }
      }

      const column = document.createElement('div');
      column.className = 'col-md-6 col-lg-4';
      column.innerHTML = `
        <div class="card h-100 shadow-sm">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">${name}</h5>
            <p class="card-text flex-grow-1">${description}</p>
            <p class="price fw-bold">${priceLabel} ${price}</p>
            ${startDate ? `<p class="mb-1"><span class="fw-semibold">${startLabel}</span> ${formatLocalizedDate(startDate)}</p>` : ''}
            ${startDate ? `<p class="mb-1"><span class="fw-semibold">${daysLabel}</span> ${daysUntilDeparture}</p>` : ''}
            <small class="text-muted d-block mt-2">${cancellationNote}</small>
            <button class="btn btn-danger btn-sm mt-3" data-reservation-id="${reservation.id}" ${cancelDisabled ? 'disabled' : ''}>${cancelLabel}</button>
          </div>
        </div>
      `;
      upcomingContainer.appendChild(column);
    });
  }

  upcomingContainer.querySelectorAll('button[data-reservation-id]').forEach(button => {
    button.addEventListener('click', event => {
      const id = event.currentTarget.getAttribute('data-reservation-id');
      if (id) {
        otkaziRezervaciju(id);
      }
    });
  });

  visitedContainer.innerHTML = '';
  if (visited.length === 0) {
    visitedEmptyState.style.display = 'block';
  } else {
    visitedEmptyState.style.display = 'none';
    visited.forEach(({ reservation, startDate }) => {
      const name = resolveLocalizedValue(reservation.naziv) || '';
      const description = resolveLocalizedValue(reservation.opis) || '';
      const price = reservation.cena || '';
      const currentRating = reservation.rating && Number.isFinite(Number(reservation.rating)) ? Number(reservation.rating) : null;
      const ratingOptions = [5, 4, 3, 2, 1].map(value => `<option value="${value}">${value}</option>`).join('');
      const column = document.createElement('div');
      column.className = 'col-md-6 col-lg-4';
      column.innerHTML = `
        <div class="card h-100 shadow-sm">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">${name}</h5>
            <p class="card-text flex-grow-1">${description}</p>
            <p class="price fw-bold">${priceLabel} ${price}</p>
            ${startDate ? `<p class="mb-1"><span class="fw-semibold">${startLabel}</span> ${formatLocalizedDate(startDate)}</p>` : ''}
            <p class="small text-muted mb-2">${ratingPrompt}</p>
            <div class="d-flex flex-wrap align-items-center gap-2">
              <label class="form-label mb-0" for="rating-${reservation.id}">${ratingLabel}</label>
              <select class="form-select form-select-sm w-auto" id="rating-${reservation.id}" data-rating-select="${reservation.id}">
                <option value="">${ratingPlaceholder}</option>
                ${ratingOptions}
              </select>
              <button type="button" class="btn btn-primary btn-sm" data-save-rating="${reservation.id}">${saveRating}</button>
            </div>
            <small class="d-block mt-2" data-rating-info="${reservation.id}">${currentRating ? `${currentRatingLabel} ${currentRating}` : noRatingLabel}</small>
            <small class="mt-2 d-none" data-rating-feedback="${reservation.id}"></small>
          </div>
        </div>
      `;
      visitedContainer.appendChild(column);
      const select = column.querySelector(`select[data-rating-select="${reservation.id}"]`);
      if (select) {
        select.value = currentRating ? String(currentRating) : '';
      }
    });

    visitedContainer.querySelectorAll('button[data-save-rating]').forEach(button => {
      button.addEventListener('click', event => {
        const id = event.currentTarget.getAttribute('data-save-rating');
        if (!id) {
          return;
        }
        const select = visitedContainer.querySelector(`select[data-rating-select="${id}"]`);
        const feedback = visitedContainer.querySelector(`[data-rating-feedback="${id}"]`);
        const info = visitedContainer.querySelector(`[data-rating-info="${id}"]`);
        if (!select) {
          return;
        }
        const rawValue = select.value;
        const numericValue = Number(rawValue);
        if (!rawValue || !Number.isFinite(numericValue) || numericValue < 1 || numericValue > 5) {
          select.classList.add('is-invalid');
          if (feedback) {
            feedback.textContent = ratingRequired;
            feedback.classList.remove('d-none', 'text-success');
            feedback.classList.add('text-danger');
          }
          return;
        }
        select.classList.remove('is-invalid');
        if (feedback) {
          feedback.textContent = ratingSaved;
          feedback.classList.remove('d-none', 'text-danger');
          feedback.classList.add('text-success');
        }
        if (info) {
          info.textContent = `${currentRatingLabel} ${numericValue}`;
        }
        sacuvajOcenu(id, numericValue);
      });
    });
  }
}

/**
 * Persists a rating for a reservation and recalculates its normalised value.
 * @param {string} reservationId Identifier of the reservation being updated.
 * @param {number} ratingValue Raw rating submitted by the user.
 */
function sacuvajOcenu(reservationId, ratingValue) {
  const reservations = safeParseReservations();
  ensureReservationDefaults(reservations);
  const targetIndex = reservations.findIndex(reservation => reservation && reservation.id === reservationId);
  if (targetIndex === -1) {
    return;
  }
  reservations[targetIndex].rating = Math.min(5, Math.max(1, Math.round(ratingValue)));
  persistReservations(reservations);
}

/**
 * Removes a reservation when cancellation is still allowed, otherwise alerts the user.
 * @param {string} reservationId Identifier of the reservation to cancel.
 */
function otkaziRezervaciju(reservationId) {
  const reservations = safeParseReservations();
  const index = reservations.findIndex(reservation => reservation && reservation.id === reservationId);
  if (index === -1) {
    return;
  }
  const reservation = reservations[index];
  const cancelUnavailable = translateKey('account.cancelUnavailable') || 'Otkazivanje više nije moguće.';
  const startDate = parseStoredDate(reservation.startDate);
  if (startDate) {
    const today = new Date();
    const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const diffDays = Math.round((startDate - startOfToday) / MS_PER_DAY);
    if (diffDays < 5) {
      window.alert(cancelUnavailable);
      return;
    }
  }
  reservations.splice(index, 1);
  persistReservations(reservations);
  prikaziRezervacije();
}

/**
 * Clears all saved reservations after confirming with the user.
 */
function clearReservations() {
  const message = translateKey('account.clearConfirm') || 'Da li ste sigurni?';
  if (!window.confirm(message)) {
    return;
  }
  localStorage.removeItem('rezervacije');
  prikaziRezervacije();
}

/**
 * Creates a new reservation entry, stores it, and redirects the user to the account page.
 * @param {string} srNaziv Serbian title of the arrangement.
 * @param {string} enNaziv English title of the arrangement.
 * @param {string} srOpis Serbian description.
 * @param {string} enOpis English description.
 * @param {string} cena Price label to display.
 * @param {string|Date} startDate Desired start date, if provided.
 */
function rezervisiAranzman(srNaziv, enNaziv, srOpis, enOpis, cena, startDate) {
  const reservations = safeParseReservations();
  const normalizedDate = normalizeDateString(startDate) || null;
  const timestamp = Date.now();
  reservations.push({
    id: `res-${timestamp}`,
    naziv: { sr: srNaziv, en: enNaziv },
    opis: { sr: srOpis, en: enOpis },
    cena,
    startDate: normalizedDate,
    visited: false,
    rating: null,
    createdAt: new Date(timestamp).toISOString()
  });
  persistReservations(reservations);
  window.location.href = 'mojnalog.html';
}

document.addEventListener('DOMContentLoaded', () => {
  initLanguage();

  document.querySelectorAll('.lang-btn').forEach(button => {
    button.addEventListener('click', () => {
      const { lang } = button.dataset;
      if (lang) {
        setLanguage(lang);
      }
    });
  });

  if (document.body.dataset.page === 'account') {
    prikaziRezervacije();
    const clearButton = document.getElementById('clear-reservations');
    if (clearButton) {
      clearButton.addEventListener('click', clearReservations);
    }
  }
});
